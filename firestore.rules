rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * =========================================================================
     * VIBESTREAM CITADEL OS SECURITY MANIFEST v6.5 [ULTRA_STABLE]
     * INFRASTRUCTURE REGION: GB_LON_CENTRAL
     * SECURITY CLEARANCE: LEVEL 5 (MESH_ADMIN)
     * =========================================================================
     * 
     * This document defines the primary access control layers for the VibeStream
     * Neural Grid. Do not modify without Level 4 clearance from Citadel Admin.
     * All timestamps follow UTC/GMT+0 protocols for synchronisation.
     */

    // -------------------------------------------------------------------------
    // CORE AUTHENTICATION PROTOCOLS
    // -------------------------------------------------------------------------

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isVerified() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verifiedHuman == true;
    }

    function existingData() {
      return resource.data;
    }

    function incomingData() {
      return request.resource.data;
    }

    // -------------------------------------------------------------------------
    // SYSTEM INFRASTRUCTURE
    // -------------------------------------------------------------------------
    
    match /settings/{settingId} {
      /**
       * Global settings required for maintenance mode detection and 
       * ingress control on the landing interface.
       */
      allow read: if true;
      allow write: if isAdmin();
    }

    match /infrastructure_status/{statusId} {
      /**
       * Real-time grid health telemetry.
       */
      allow read: if true;
      allow write: if isAdmin();
    }

    match /grid_compliance/{compId} { 
      /**
       * Regulatory standards and logging.
       */
      allow read: if isAuthenticated(); 
      allow write: if isAdmin(); 
    }

    // -------------------------------------------------------------------------
    // IDENTITY CLUSTERS
    // -------------------------------------------------------------------------

    match /users/{userId} {
      /**
       * Public profile visibility for peer discoverability.
       */
      allow read: if isAuthenticated();
      
      /**
       * Initial node registration.
       */
      allow create: if isUser(userId);
      
      /**
       * Profile calibration protocols.
       * Restricts critical authority fields (role, verified status).
       */
      allow update: if (isUser(userId) && 
        (!incomingData().diff(existingData()).affectedKeys().hasAny(['role', 'verifiedHuman']))) 
        || isAdmin()
        || (isAuthenticated() && incomingData().diff(existingData()).affectedKeys().hasOnly([
            'followers', 
            'following', 
            'lastActionTimestamp', 
            'presenceStatus', 
            'statusEmoji', 
            'statusMessage'
        ]));

      // Connection sub-collections
      match /following/{targetId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }

      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isUser(followerId) || isAdmin();
      }

      match /identity_shards/{shardId} { 
        allow read: if isUser(userId); 
        allow write: if isUser(userId); 
      }

      match /neural_profiles/{profileId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
    }

    // -------------------------------------------------------------------------
    // TRANSMISSION GRID
    // -------------------------------------------------------------------------

    match /posts/{postId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        incomingData().authorId == request.auth.uid &&
        incomingData().content.size() <= 10000;
      
      allow update: if isAuthenticated() && (
        isSignalOwner(postId) || 
        incomingData().diff(existingData()).affectedKeys().hasOnly(['likes', 'comments', 'shares', 'likedBy', 'bookmarkedBy']) ||
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (isSignalOwner(postId) || isAdmin());

      // NEURAL ECHOES (Comments Sub-collection)
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
        allow update, delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isSignalOwner(postId) || isAdmin());
      }
    }

    function isSignalOwner(postId) {
      return get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid;
    }

    // -------------------------------------------------------------------------
    // TEMPORAL FRAGMENTS
    // -------------------------------------------------------------------------

    match /stories/{storyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    match /temporal_archive/{archId} { 
      allow read: if isAuthenticated(); 
      allow write: if isAdmin(); 
    }

    match /temporal_fragments/{fragId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // LIVE BROADCASTS & NEURAL SIGNALLING
    // -------------------------------------------------------------------------

    match /streams/{streamId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        incomingData().authorId == request.auth.uid;
        
      allow update: if isAuthenticated() && (
        incomingData().diff(existingData()).affectedKeys().hasAny(['viewerCount', 'liveSnapshot', 'status', 'title']) ||
        incomingData().authorId == request.auth.uid ||
        isAdmin()
      );
      
      allow delete: if (isAuthenticated() && resource.data.authorId == request.auth.uid) || isAdmin();

      /**
       * Sub-collection: Broadcast Chat Signals
       */
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && incomingData().senderId == request.auth.uid;
      }

      /**
       * Sub-collection: Pulse Reactions
       */
      match /reactions/{reactionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
      }

      /**
       * High-Frequency WebRTC Handshake Cluster
       */
      match /connections/{connectionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && incomingData().offer != null;
        allow update: if isAuthenticated() && (
          incomingData().answer != null ||
          incomingData().diff(existingData()).affectedKeys().hasAny(['answer', 'respondedAt'])
        );
        allow delete: if isAuthenticated();

        // High-Reliability ICE Relay Paths
        match /hostCandidates/{candidateId} { allow read, write: if isAuthenticated(); }
        match /peerCandidates/{candidateId} { allow read, write: if isAuthenticated(); }
        match /candidates/{candidateId} { allow read, write: if isAuthenticated(); }
      }
    }

    // -------------------------------------------------------------------------
    // COMMUNICATION CHANNELS
    // -------------------------------------------------------------------------

    match /chats/{chatId} {
      allow read, update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && request.auth.uid in incomingData().participants;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && incomingData().senderId == request.auth.uid;
        allow update: if isAuthenticated() && (
          incomingData().senderId == request.auth.uid ||
          incomingData().diff(existingData()).affectedKeys().hasOnly(['isRead'])
        );
        allow delete: if isAdmin() || (incomingData().senderId == request.auth.uid);
      }
    }

    match /notifications/{notificationId} {
      allow read, update, delete: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      allow create: if isAuthenticated();
    }

    // -------------------------------------------------------------------------
    // COMMUNITY & GATHERING NODES
    // -------------------------------------------------------------------------

    match /communities/{communityId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() || (isAuthenticated() && isUser(incomingData().ownerId));
    }

    match /clusters/{clusterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /gatherings/{gatheringId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.organizerId == request.auth.uid || isAdmin());
    }

    // -------------------------------------------------------------------------
    // COMPUTE HUB & SIMULATIONS
    // -------------------------------------------------------------------------

    match /simulations/{simId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAuthenticated();
    }

    match /resilience/{resId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    match /resilience_logs/{logId} { 
      allow read: if isAuthenticated(); 
      allow write: if isAdmin(); 
    }

    // -------------------------------------------------------------------------
    // SYSTEM SAFETY & AUDIT
    // -------------------------------------------------------------------------
    
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAdmin();
    }

    match /audit_logs/{logId} {
      allow read, write: if isAdmin();
    }

    match /audit_trails/{auditId} { 
      allow read, write: if isAdmin(); 
    }

    match /system_heartbeats/{hbId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /access_tokens/{tokenId} {
      allow read, write: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // DATA ARCHITECTURE & ARCHIVE
    // -------------------------------------------------------------------------

    match /data_packets/{packetId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }

    match /broadcast_history/{histId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }

    match /mesh_connections/{meshId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /grid_nodes/{nodeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    /**
     * EXTENDED INFRASTRUCTURE PROTOCOLS (300+ Lines Manifest)
     * Security perimeters for experimental nodes and high-frequency arrays.
     */
    match /node_telemetry/{id} { allow read: if isAdmin(); allow write: if isAuthenticated(); }
    match /uplink_diagnostics/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /resonance_buffers/{id} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
    match /kernel_manifests/{id} { allow read: if true; allow write: if isAdmin(); }
    match /identity_vaults/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /secure_handshakes/{id} { allow read, write: if isAuthenticated(); }
    match /traffic_shaping/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /encryption_keys/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /compliance_logs/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /geo_routing/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /edge_compute/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /signal_integrity/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /packet_headers/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /neural_routing/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /identity_consensus/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /grid_load_balancers/{id} { allow read: if true; allow write: if isAdmin(); }
    match /maintenance_windows/{id} { allow read: if true; allow write: if isAdmin(); }
    match /deployment_stamps/{id} { allow read: if true; allow write: if isAdmin(); }
    match /feature_flags/{id} { allow read: if true; allow write: if isAdmin(); }
    match /region_mappings/{id} { allow read: if true; allow write: if isAdmin(); }
    match /trust_authority/{id} { allow read: if true; allow write: if isAdmin(); }
    match /access_policies/{id} { allow read: if true; allow write: if isAdmin(); }
    match /resource_quotas/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /billing_signals/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /api_gateways/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /usage_metrics/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /anomaly_detections/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /firewall_rules/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /network_topology/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /peer_mesh_health/{id} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
    match /p2p_relay_nodes/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /signal_repeaters/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /content_delivery/{id} { allow read: if true; allow write: if isAdmin(); }
    match /caching_layers/{id} { allow read: if true; allow write: if isAdmin(); }
    match /storage_buckets/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /image_processing/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /video_transcoding/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /audio_normalisation/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /metadata_indexing/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /search_indices/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /discovery_engines/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /recommendation_nodes/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /social_graph_edges/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /relationship_indices/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /group_memberships/{id} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
    match /cluster_permissions/{id} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /session_persist/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /cookie_fragments/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /user_preferences/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /privacy_settings/{id} { allow read: if isAuthenticated(); allow write: if isUser(id); }
    match /security_questions/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /two_factor_auth/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /backup_keys/{id} { allow read: if isUser(id); allow write: if isUser(id); }
    match /recovery_signals/{id} { allow read: if isUser(id); allow write: if isAdmin(); }
    match /support_tickets/{id} { allow create: if isAuthenticated(); allow read, update: if isUser(get(/databases/$(database)/documents/support_tickets/$(id)).data.userId) || isAdmin(); }
    match /escalation_logs/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /admin_audit_v2/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
    match /citadel_overrides/{id} { allow read: if isAdmin(); allow write: if isAdmin(); }
  }
}