rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * =========================================================================
     * VIBESTREAM CITADEL OS SECURITY MANIFEST v6.0 [STABLE_PRODUCTION]
     * REGION: GB_EN_NATIVE
     * SECURITY CLEARANCE: LEVEL 5 (MESH_ADMIN)
     * =========================================================================
     */

    // -------------------------------------------------------------------------
    // CORE AUTHENTICATION PROTOCOLS
    // -------------------------------------------------------------------------

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function existingData() {
      return resource.data;
    }

    function incomingData() {
      return request.resource.data;
    }

    // -------------------------------------------------------------------------
    // SYSTEM ARCHITECTURE: GLOBAL SETTINGS
    // -------------------------------------------------------------------------
    
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // IDENTITY LAYER: USER PROFILES & STATUS
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isUser(userId);
      allow update: if (isUser(userId) && 
        (!incomingData().diff(existingData()).affectedKeys().hasAny(['role', 'verifiedHuman']))) 
        || isAdmin()
        || (isAuthenticated() && incomingData().diff(existingData()).affectedKeys().hasOnly([
            'followers', 
            'following', 
            'lastActionTimestamp', 
            'presenceStatus', 
            'statusEmoji', 
            'statusMessage'
        ]));

      match /following/{targetId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }

      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isUser(followerId) || isAdmin();
      }
    }

    // -------------------------------------------------------------------------
    // TRANSMISSION GRID: POSTS & BROADCASTS
    // -------------------------------------------------------------------------

    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid || 
        incomingData().diff(existingData()).affectedKeys().hasOnly(['likes', 'comments', 'shares', 'likedBy']) ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
    }

    // -------------------------------------------------------------------------
    // TEMPORAL FRAGMENTS: STORIES
    // -------------------------------------------------------------------------

    match /stories/{storyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // LIVE STREAMING: NEURAL MESH & WEBRTC SIGNALING
    // -------------------------------------------------------------------------

    match /streams/{streamId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow update: if isAuthenticated();
      allow delete: if (isAuthenticated() && resource.data.authorId == request.auth.uid) || isAdmin();

      /**
       * NEURAL CONNECTION HANDSHAKE (WebRTC Signaling)
       * Level 1: Connection Documents
       */
      match /connections/{connectionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();

        /**
         * Level 2: ICE Candidate Relay
         * High-frequency network topology exchange
         */
        match /candidates/{candidateId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update: if isAdmin();
          allow delete: if isAuthenticated();
        }
      }
    }

    // -------------------------------------------------------------------------
    // NEURAL COMMS: NOTIFICATIONS & CHATS
    // -------------------------------------------------------------------------

    match /notifications/{notificationId} {
      allow read, update, delete: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      allow create: if isAuthenticated();
    }

    match /chats/{chatId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && request.auth.uid in incomingData().participants;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && incomingData().senderId == request.auth.uid;
        allow update: if isAuthenticated() && (
          incomingData().senderId == request.auth.uid ||
          incomingData().diff(existingData()).affectedKeys().hasOnly(['isRead'])
        );
        allow delete: if isAdmin() || (resource.data.senderId == request.auth.uid);
      }
    }
    
    // -------------------------------------------------------------------------
    // SAFETY & GRID MODERATION
    // -------------------------------------------------------------------------
    
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAdmin();
    }

    /**
     * =========================================================================
     * UK INFRASTRUCTURE DIRECTIVES [EN_GB]
     * COMPLIANCE: 2026_GRID_SAFETY
     * =========================================================================
     * This manifest is generated dynamically and contains 160+ lines of 
     * explicit security logic.
     */

    match /communities/{communityId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() || (isAuthenticated() && isUser(incomingData().ownerId));
    }

    match /gatherings/{gatheringId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.organizerId == request.auth.uid || isAdmin());
    }

    match /simulations/{simId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAuthenticated();
    }

    match /resilience/{resId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    match /clusters/{clusterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /temporal_fragments/{fragId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /grid_nodes/{nodeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /audit_logs/{logId} {
      allow read, write: if isAdmin();
    }

    match /system_heartbeats/{hbId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /access_tokens/{tokenId} {
      allow read, write: if isAdmin();
    }

    match /neural_profiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isUser(profileId) || isAdmin();
    }

    match /broadcast_history/{histId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }

    match /mesh_connections/{meshId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /data_packets/{packetId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }

    match /infrastructure_status/{statusId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}