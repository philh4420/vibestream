
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * =========================================================================
     * VIBESTREAM CITADEL OS SECURITY MANIFEST v10.1 [CLEANUP_STABLE]
     * INFRASTRUCTURE REGION: GB_LON_CENTRAL
     * SECURITY CLEARANCE: LEVEL 5 (MESH_ADMIN)
     * =========================================================================
     */

    // -------------------------------------------------------------------------
    // CORE AUTHENTICATION PROTOCOLS
    // -------------------------------------------------------------------------

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isVerified() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verifiedHuman == true;
    }

    function existingData() {
      return resource.data;
    }

    function incomingData() {
      return request.resource.data;
    }

    // -------------------------------------------------------------------------
    // SYSTEM INFRASTRUCTURE & HEARTBEAT
    // -------------------------------------------------------------------------
    
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /infrastructure_status/{statusId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /grid_compliance/{compId} { 
      allow read: if isAuthenticated(); 
      allow write: if isAdmin(); 
    }

    // -------------------------------------------------------------------------
    // IDENTITY CLUSTERS & BIO-SIGNATURES
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isUser(userId);
      
      allow update: if 
        isAdmin() ||
        (isUser(userId) && (!incomingData().diff(existingData()).affectedKeys().hasAny(['role', 'verifiedHuman']))) ||
        (isAuthenticated() && incomingData().diff(existingData()).affectedKeys().hasOnly([
            'followers', 
            'following', 
            'lastActionTimestamp', 
            'presenceStatus', 
            'statusEmoji', 
            'statusMessage',
            'resonance',
            'cosmetics'
        ]));

      match /following/{targetId} {
        allow read, list: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }

      match /followers/{followerId} {
        allow read, list: if isAuthenticated();
        allow write: if isUser(followerId) || isAdmin();
      }

      match /blocked/{targetId} {
        allow read, write: if isUser(userId);
      }

      match /blockedBy/{blockerId} {
        allow read: if isUser(userId);
        allow create, delete: if isUser(blockerId);
      }

      match /identity_shards/{shardId} { 
        allow read: if isUser(userId); 
        allow write: if isUser(userId); 
      }
    }

    // -------------------------------------------------------------------------
    // TRANSMISSION GRID & PACKET PULSES (Feed)
    // -------------------------------------------------------------------------

    match /posts/{postId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.authorId == request.auth.uid && incomingData().diff(existingData()).affectedKeys().hasAny(['content', 'media', 'contentLengthTier', 'updatedAt'])) ||
        incomingData().diff(existingData()).affectedKeys().hasOnly(['likes', 'comments', 'shares', 'likedBy', 'bookmarkedBy', 'inlineReactions', 'reactions', 'pollVotes', 'pollVoters', 'pollTotalVotes'])
      );
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());

      match /comments/{commentId} {
        allow read, list: if isAuthenticated();
        allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
        allow delete: if isAuthenticated() && (
          resource.data.authorId == request.auth.uid || 
          get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid || 
          isAdmin()
        );
        allow update: if isAuthenticated() && (
          (resource.data.authorId == request.auth.uid && incomingData().diff(existingData()).affectedKeys().hasAny(['content', 'media', 'updatedAt'])) ||
          isAdmin()
        );
      }
    }

    // -------------------------------------------------------------------------
    // TEMPORAL FRAGMENTS (Stories) & SONIC ECHOES
    // -------------------------------------------------------------------------

    match /stories/{storyId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    match /echoes/{echoId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      allow update: if isAuthenticated() && (incomingData().diff(existingData()).affectedKeys().hasOnly(['listens']));
    }

    // -------------------------------------------------------------------------
    // LIVE BROADCASTS & WEBRTC
    // -------------------------------------------------------------------------

    match /streams/{streamId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated() && incomingData().authorId == request.auth.uid;
      allow update: if isAuthenticated() && (
        incomingData().authorId == request.auth.uid ||
        isAdmin() ||
        incomingData().diff(existingData()).affectedKeys().hasAny(['viewerCount', 'liveSnapshot', 'status', 'title'])
      );
      allow delete: if (isAuthenticated() && resource.data.authorId == request.auth.uid) || isAdmin();

      match /messages/{messageId} {
        allow read, list: if isAuthenticated();
        allow create: if isAuthenticated();
      }

      match /reactions/{reactionId} {
        allow read, list: if isAuthenticated();
        allow create: if isAuthenticated();
      }

      match /connections/{connectionId} {
        allow read, list: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
        match /hostCandidates/{candidateId} { allow read, write: if isAuthenticated(); }
        match /peerCandidates/{candidateId} { allow read, write: if isAuthenticated(); }
      }
    }

    // -------------------------------------------------------------------------
    // COMMUNICATION CHANNELS
    // -------------------------------------------------------------------------

    match /chats/{chatId} {
      allow read, list: if isAuthenticated() && (
        resource.data.participants.hasAny([request.auth.uid]) || 
        (resource.data.keys().hasAny(['isEventLobby']) && resource.data.isEventLobby == true)
      );
      allow create: if isAuthenticated() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isAuthenticated() && (
        resource.data.participants.hasAny([request.auth.uid]) ||
        ((resource.data.keys().hasAny(['isEventLobby']) && resource.data.isEventLobby == true) && 
          request.resource.data.participants.hasAny([request.auth.uid])) ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data.participants.hasAny([request.auth.uid])) || isAdmin()
      );
      
      match /messages/{messageId} {
        allow read, list: if isAuthenticated() && (
          get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) || 
          get(/databases/$(database)/documents/chats/$(chatId)).data.isEventLobby == true
        );
        allow create: if isAuthenticated() && (
          incomingData().senderId == request.auth.uid ||
          (incomingData().senderId == 'SYSTEM' && (
            get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) || 
            get(/databases/$(database)/documents/chats/$(chatId)).data.isEventLobby == true
          ))
        );
        allow update: if isAuthenticated() && (
          existingData().senderId == request.auth.uid ||
          (get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) && 
           incomingData().diff(existingData()).affectedKeys().hasOnly(['isRead']))
        );
        allow delete: if isAdmin() || (resource.data.senderId == request.auth.uid);
      }
    }

    match /notifications/{notificationId} {
      allow read, list: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      allow create: if isAuthenticated();
    }

    // -------------------------------------------------------------------------
    // COMMUNITY & GATHERINGS
    // -------------------------------------------------------------------------

    match /communities/{communityId} {
      allow read, list: if isAuthenticated();
      allow create, update: if isAdmin() || (isAuthenticated() && isUser(incomingData().ownerId));
    }

    match /gatherings/{gatheringId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.organizerId == request.auth.uid || 
        isAdmin() || 
        incomingData().diff(existingData()).affectedKeys().hasAny(['attendees', 'waitlist', 'latestStatus'])
      );
      allow delete: if isAuthenticated() && (resource.data.organizerId == request.auth.uid || isAdmin());

      match /memories/{memoryId} {
        allow read, list: if isAuthenticated();
        allow create: if isAuthenticated();
        allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
      }
    }

    // -------------------------------------------------------------------------
    // MISC / LEGACY / FUTURE NODES
    // -------------------------------------------------------------------------

    match /resonance_ledger/{txId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    match /marketplace_inventory/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
