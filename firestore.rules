rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // AETHER PROTOCOL SECURITY MANIFEST v5.0 [GLOBAL_EN_GB]
    // =========================================================================
    // Enhanced Security Mesh for VibeStream 2026. 
    // This protocol incorporates Neural Bot-Shielding and Node-Integrity checks.
    
    // --- Global Utility Protocol ---
    
    // Basic Authentication Verification
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Identity Alignment check
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Neural Verification Check (Anti-Bot Shield)
    function isVerifiedHuman() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verifiedHuman == true;
    }

    // Administrative Clearance Logic
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        'role' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator', 'system'];
    }

    // Anti-Spam / Rate Limiting (Neural Cooldown)
    function isNotRateLimited() {
      return !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
        request.time > get(/databases/$(database)/documents/users/$(request.auth.uid)).data.lastActionTimestamp + duration.value(2, 's');
    }

    // --- Sub-Protocol: Identity Resolution (Users) ---

    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Verification: Neural identity creation requires self-alignment.
      allow create: if isUser(userId) && 
        (!('role' in request.resource.data) || request.resource.data.role == 'member') &&
        request.resource.data.geoNode == 'UK';
      
      // Interface Synchronisation: 
      // 1. Owners manage non-privileged metadata.
      // 2. Administrators possess total override authority.
      // 3. Automated systems update resonance/follower metrics.
      allow update: if (isUser(userId) && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'verifiedHuman', 'neuralIntegrityScore']))) 
                    || isAdmin()
                    || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followersCount', 'followingCount', 'totalLikesReceived', 'lastActionTimestamp', 'minutesLive', 'groupsJoined', 'presenceTrail', 'neuralCluster', 'pinnedPostId']));

      // Sub-Collection: Outbound Signal Links (Following)
      match /following/{targetId} {
        allow read: if isAuthenticated();
        allow write: if (isUser(userId) || request.auth.uid == targetId) && isVerifiedHuman();
      }

      // Sub-Collection: Inbound Signal Links (Followers)
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if (isUser(followerId) || isUser(userId)) && isVerifiedHuman();
      }
    }

    // --- Sub-Protocol: Neural Transmissions (Posts) ---

    match /posts/{postId} {
      allow read: if isAuthenticated();
      
      // Transmission Source: Must match authenticated node and pass Bot-Shield.
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid && 
        isVerifiedHuman() && 
        isNotRateLimited() &&
        request.resource.data.content.size() > 0;
      
      // Signal Modulation:
      // - Author: Full access.
      // - Peers: Increment interaction metadata.
      // - Admin: Safety override.
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy', 'commentsCount', 'shares', 'isPinned']) ||
        isAdmin()
      );
      
      // Transmission Termination: Restricted to Author or Admin.
      allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());

      // Feedback Tunnel: Sub-Signals (Comments)
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
          request.resource.data.authorId == request.auth.uid && 
          isVerifiedHuman() && 
          isNotRateLimited();
          
        allow update: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
        
        // Removal Hierarchy: Commenter OR Post Host OR Admin.
        allow delete: if isAuthenticated() && (
          resource.data.authorId == request.auth.uid || 
          (exists(/databases/$(database)/documents/posts/$(postId)) && get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid) ||
          isAdmin()
        );
      }
      
      // Observer Metadata: Ephemeral Presence Tracking.
      match /presence/{viewerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.auth.uid == viewerId;
      }

      // Versioning Sub-Protocol: Historical Archives.
      match /versions/{versionId} {
        allow read: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
        allow create: if isAuthenticated() && request.auth.uid == get(/databases/$(database)/documents/posts/$(postId)).data.authorId;
      }
    }

    // --- Sub-Protocol: Network Notifications ---

    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.fromUserId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
    }

    // --- Sub-Protocol: Connection Requests (Handshakes) ---

    match /friend_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource == null || 
        resource.data.toUserId == request.auth.uid || 
        resource.data.fromUserId == request.auth.uid
      );
      allow create: if isAuthenticated() && isVerifiedHuman() && request.resource.data.fromUserId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (resource.data.toUserId == request.auth.uid || resource.data.fromUserId == request.auth.uid);
    }
    
    // --- Sub-Protocol: Secure Transmission Channels (Chats) ---

    match /chats/{chatId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && isVerifiedHuman() && request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow delete: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        allow read, create, update, delete: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }

    // --- Sub-Protocol: Live Broadcast Hubs ---

    match /live_rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isVerifiedHuman() && request.resource.data.hostId == request.auth.uid;
      
      // Node Modulation: Host or Admin only. Observers restricted to interaction counts.
      allow update: if isAuthenticated() && (
        resource.data.hostId == request.auth.uid || 
        isAdmin() || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewerCount', 'widgets', 'status', 'lastPulse'])
      );
      allow delete: if isAuthenticated() && (resource.data.hostId == request.auth.uid || isAdmin());

      // Broadcast Feedback Feed (Room Chat)
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isVerifiedHuman() && isNotRateLimited(); 
        allow delete, update: if isAuthenticated() && (resource.data.senderId == request.auth.uid || isAdmin());
      }

      // Observer Registry
      match /presence/{userId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId);
      }

      // Resonance Tracking (Reactions)
      match /reactions/{reactionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isVerifiedHuman();
      }

      // Co-Pilot Queue (Stage Requests)
      match /stage_requests/{requestId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isVerifiedHuman() && request.auth.uid == requestId;
        allow update, delete: if isAuthenticated() && (
            request.auth.uid == requestId || 
            get(/databases/$(database)/documents/live_rooms/$(roomId)).data.hostId == request.auth.uid ||
            isAdmin()
        );
      }

      // Active Broadcast Panel Members
      match /panel/{panelId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (
            get(/databases/$(database)/documents/live_rooms/$(roomId)).data.hostId == request.auth.uid ||
            isAdmin()
        );
      }

      // WebRTC Mesh Topography (Signaling)
      match /peers/{viewerId} {
        allow read, write: if isAuthenticated() && isVerifiedHuman();
        
        match /offerCandidates/{candidateId} {
            allow read, write: if isAuthenticated();
        }
        match /answerCandidates/{candidateId} {
            allow read, write: if isAuthenticated();
        }
        match /hostCandidates/{candidateId} {
            allow read, write: if isAuthenticated();
        }
        match /viewerCandidates/{candidateId} {
            allow read, write: if isAuthenticated();
        }
      }
    }

    // --- Sub-Protocol: Secure Telephony (Calls) ---

    match /calls/{callId} {
      allow read, create: if isAuthenticated() && isVerifiedHuman();
      allow update: if isAuthenticated(); 
      allow delete: if isAuthenticated() && (resource.data.callerId == request.auth.uid || resource.data.calleeId == request.auth.uid);
      
      match /offerCandidates/{candidateId} {
        allow read, write: if isAuthenticated();
      }
      match /answerCandidates/{candidateId} {
        allow read, write: if isAuthenticated();
      }
    }

    // --- Sub-Protocol: Community Archives (Groups) ---

    match /groups/{groupId} {
      allow read: if isAuthenticated();
      // Allow verified nodes to create groups
      allow create: if isAuthenticated() && isVerifiedHuman() && request.resource.data.createdBy == request.auth.uid;
      // Allow host or admin to update metadata
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isAdmin() || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount', 'activeNodes']));
      // Deletion restricted to host or admin
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.createdBy == request.auth.uid);

      // Membership sub-collection tracking
      match /members/{memberId} {
        allow read: if isAuthenticated();
        // Users manage their own membership status
        allow write: if isUser(memberId) && isVerifiedHuman();
      }
    }

    // --- Sub-Protocol: Dynamic Trends ---

    match /trends/{trendId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Sub-Protocol: Synchronous Events Matrix ---

    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isVerifiedHuman();
      
      // Permissions: Host can modify; participants can update RSVP metadata.
      allow update: if isAuthenticated() && (
        resource.data.hostId == request.auth.uid || 
        request.resource.data.diff(resource.data).affectedKeys().hasAny(['attendees', 'waitlist', 'interested']) || 
        isAdmin()
      );
      allow delete: if isAuthenticated() && (resource.data.hostId == request.auth.uid || isAdmin());

      // Lobby Synchronization (The Green Room)
      match /lobby/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/events/$(eventId)).data.attendees;
        allow create: if isAuthenticated() && isVerifiedHuman() && request.auth.uid in get(/databases/$(database)/documents/events/$(eventId)).data.attendees;
      }
    }
    
    // --- Sub-Protocol: Citadel Intelligence (Reports) ---
    
    match /reports/{reportId} {
      allow create: if isAuthenticated() && isVerifiedHuman();
      allow read, update, delete: if isAdmin();
    }
    
    // --- System Node: Configuration ---
    
    match /system/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}